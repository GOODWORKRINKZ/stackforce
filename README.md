# Прошивка для четырехногого колесного робота StackForce

## Описание проекта

Полная прошивка для **четырехногого колесного робота** с использованием **двух ESP32 контроллеров** (main и aux), связанных через CAN шину.

### Архитектура системы v2.0

```
┌────────────────────────────────────────────────────────────┐
│                   РОБОТ STACKFORCE                          │
│            (Четырехногий колесный робот)                     │
└────────────────────────────────────────────────────────────┘

┌─────────────────────┐         CAN BUS         ┌────────────────────┐
│  ESP32 MAIN         │────────────────────────►│  ESP32 AUX         │
│  (Голова)           │    1 Mbps               │  (Хвост)           │
└─────────────────────┘                         └────────────────────┘
         │                                                 │
    ┌────┴────────┐                                  ┌────┴────┐
    │SBUS Receiver│                                  │         │
    │MPU6050 IMU  │                                  │         │
    │PCA9685      │                                  │         │
    │  8x Servo   │ ◄─ Все сервоприводы             │         │
    │             │    (4 ноги × 2 серво)           │         │
    │2x BLDC(M0,M1│                                  │2x BLDC  │
    └─────────────┘                                  │ (M2,M3) │
                                                     └─────────┘
```

## Основные компоненты

### 1. ESP32 Main (Главный контроллер - голова)

**Функции:**
- ✅ Прием SBUS сигнала от FrSky приемника (16 каналов)
- ✅ Чтение IMU (MPU6050) для определения позы
- ✅ Управление **ВСЕМИ 8 сервоприводами** через PCA9685 (4 ноги × 2 серво)
- ✅ Управление 2 передними BLDC моторами (M0, M1) через Serial2
- ✅ **Обратная кинематика** для всех 4 ног (5-звенный механизм)
- ✅ **PID стабилизация** тангажа и скорости
- ✅ Отправка команд aux контроллеру по CAN (throttle, turn, height, roll, pitch)

### 2. ESP32 Aux (Вспомогательный контроллер - хвост)

**Функции:**
- ✅ Прием команд от main контроллера по CAN
- ✅ Управление 2 задними BLDC моторами (M2, M3) через Serial2
- ✅ Аварийная остановка при потере связи (500ms timeout)
- ❌ Не управляет сервоприводами (все серво на main)

## Кинематика и Походки

### Кинематика ног

**Параметры:**
- Длина плеча: 50 мм
- Длина бедра: 100 мм  
- Максимальная досягаемость: 150 мм

**Алгоритмы:**
1. **Прямая кинематика**: углы серво → позиция конца ноги
2. **Обратная кинематика**: позиция конца ноги → углы серво
   - Использует косинусную теорему
   - Проверка досягаемости цели
   - Ограничение углов в безопасных пределах

### Походки (Gaits)

| Походка | Описание | Скорость | Стабильность |
|---------|----------|----------|--------------|
| **STAND** | Стойка на месте | - | Максимальная |
| **WALK** | Шаг | Медленная | Высокая |
| **TROT** | Рысь (диагональные пары) | Средняя | Средняя |
| **BOUND** | Галоп (передние/задние пары) | Быстрая | Низкая |

**Параметры походок:**
- Высота шага: 30 мм
- Длина шага: 80 мм (масштабируется по скорости)
- Период цикла: 1000 мс
- Высота тела: 100 мм

**Фазовые смещения:**
```cpp
// Формат: [FL, FR, BL, BR]
WALK:  [0.0, 0.5, 0.75, 0.25]  // Всегда 3 ноги на земле
TROT:  [0.0, 0.5, 0.5, 0.0]    // Диагональные пары
BOUND: [0.0, 0.0, 0.5, 0.5]    // Передние и задние пары
```

## CAN шина

### Протокол связи

**Скорость:** 1 Mbps

**CAN ID сообщений:**

| ID | Направление | Описание |
|----|-------------|----------|
| 0x110 | Main → Aux | Команды управления |
| 0x120 | Aux → Main | Телеметрия |
| 0x141 | Main → Motor FL | Передний левый BLDC |
| 0x142 | Main → Motor FR | Передний правый BLDC |
| 0x143 | Aux → Motor BL | Задний левый BLDC |
| 0x144 | Aux → Motor BR | Задний правый BLDC |

### Формат команды управления (Main → Aux)

```
Байт 0: throttle + 100  (0..200, центр 100)
Байт 1: steering + 100  (0..200, центр 100)
Байт 2: mode (0..255, высота стойки)
Байт 3: speed (0..255, множитель скорости)
Байт 4-5: roll * 10 (int16, градусы * 10)
Байт 6-7: pitch * 10 (int16, градусы * 10)
```

## PPM каналы управления

| Канал | Функция | Диапазон |
|-------|---------|----------|
| 0 | Газ (вперед/назад) | -100..100 |
| 1 | Рулевое управление | -100..100 |
| 2 | Режим (высота стойки) | 0..255 |
| 3 | Множитель скорости | 0..255 |
| 4 | AUX1 (резерв) | - |
| 5 | AUX2 (резерв) | - |

## Установка и прошивка

### Требования

- [PlatformIO](https://platformio.org/) + VS Code
- 2x ESP32 DevKit
- 2x CAN трансивер (MCP2551/TJA1050)
- 2x PCA9685 (16-канальный PWM)
- 1x MPU6050 (IMU)
- 4x BLDC мотор с CAN интерфейсом
- 8x Сервопривод (MG996R или аналог)
- 1x PPM RC приемник
- Источник питания (Li-Po 3S, 11.1V)

### Прошивка Main контроллера

```bash
cd firmware/main_controller
pio run --target upload
pio device monitor
```

### Прошивка Aux контроллера

```bash
cd firmware/aux_controller
pio run --target upload
pio device monitor
```

## Подключение

### Main контроллер (ESP32 #1)

```
ESP32 Main
├── GPIO 34 → PPM вход (от RC приемника)
├── GPIO 21 → SDA (PCA9685 + MPU6050)
├── GPIO 22 → SCL (PCA9685 + MPU6050)
├── GPIO 5  → CAN TX (к MCP2551)
├── GPIO 4  → CAN RX (от MCP2551)
├── GPIO 2  → LED статус
├── GPIO 16 → LED PPM
├── GPIO 15 → LED CAN
└── GPIO 17 → LED IMU
```

### Aux контроллер (ESP32 #2)

```
ESP32 Aux
├── GPIO 21 → SDA (PCA9685)
├── GPIO 22 → SCL (PCA9685)
├── GPIO 5  → CAN TX (к MCP2551)
├── GPIO 4  → CAN RX (от MCP2551)
├── GPIO 2  → LED статус
└── GPIO 15 → LED CAN
```

### CAN шина

```
ESP32 Main  ──[MCP2551]── CANH/CANL ──[120Ω]
                            │
ESP32 Aux   ──[MCP2551]─────┤
                            │
4x BLDC     ────────────────┘
          └─[120Ω терминатор на концах]
```

## Использование

### Базовое управление

1. **Включение**: Подать питание на оба ESP32 и моторы
2. **Проверка связи**: Светодиоды должны мигать
3. **RC управление**:
   - Канал 0 (газ): вперед/назад
   - Канал 1 (руль): поворот влево/вправо
   - Канал 2 (режим): высота стойки
   - Канал 3 (скорость): ограничитель скорости

### Режимы работы

**Стойка (по умолчанию):**
- Все 4 ноги на земле
- Высота регулируется каналом MODE

**Движение:**
- Газ + руль = дифференциальное управление
- Автоматический выбор походки по скорости

### Безопасность

⚠️ **ВАЖНО:**
- При потере PPM сигнала (>500мс) → автоматическая остановка
- При потере CAN связи (>1000мс) → аварийная остановка
- Всегда начинайте с малых скоростей
- Используйте аварийный выключатель

## Калибровка

### Сервоприводы

Измените в `config.h`:
```cpp
#define SERVO_MIN_PULSE 150    // Минимум
#define SERVO_MAX_PULSE 600    // Максимум
#define SERVO_SHOULDER_OFFSET 0  // Смещение плеча
#define SERVO_HIP_OFFSET 0       // Смещение бедра
```

### Кинематика

Измените размеры ног:
```cpp
#define LEG_SHOULDER_LENGTH 50.0  // мм
#define LEG_HIP_LENGTH 100.0      // мм
```

### IMU фильтр

Настройка комплементарного фильтра:
```cpp
#define IMU_FILTER_ALPHA 0.98  // 0.96-0.99
```

## Отладка

### Serial Monitor

**Main контроллер:**
```
[MAIN] PPM: T=50 S=-20 M=128 Sp=200 | Motors: FL=1500 FR=1800 | IMU: R=-2.5 P=1.3
```

**Aux контроллер:**
```
[AUX] Cmd: T=50 S=-20 M=128 | Motors: BL=1500 BR=1800 | IMU: R=-2.5 P=1.3
```

### Типичные проблемы

**CAN связь не работает:**
- Проверьте терминаторы 120Ом
- Проверьте CANH/CANL подключение
- Общий GND обязателен

**PPM не принимается:**
- Приемник должен быть в PPM режиме
- GPIO34 только вход
- Проверьте бинд с передатчиком

**Моторы не вращаются:**
- Проверьте CAN ID моторов (0x141-0x144)
- Проверьте питание BLDC контроллеров
- Проверьте скорость CAN (1 Mbps)

## Структура проекта

```
firmware/
├── main_controller/          # ESP32 Main (передняя часть)
│   ├── include/
│   │   ├── config.h         # Конфигурация
│   │   └── kinematics.h     # Кинематика и походки
│   ├── src/
│   │   └── main.cpp         # Основной код
│   └── platformio.ini
│
└── aux_controller/           # ESP32 Aux (задняя часть)
    ├── include/
    │   └── config.h         # Конфигурация
    ├── src/
    │   └── main.cpp         # Основной код
    └── platformio.ini

docs/
├── QUICKSTART.md            # Быстрый старт
└── HARDWARE.md              # Схемы подключения
```

## Лицензия

Apache 2.0 - на основе открытых проектов StackForce

## Авторы

- Оригинальные проекты: [StackForce на Gitee](https://gitee.com/StackForce)
- Разработка прошивки: GOODWORKRINKZ

## Дополнительные ресурсы

- [Документация ESP32](https://docs.espressif.com/)
- [PlatformIO](https://docs.platformio.org/)
- [StackForce сайт](https://stackforce.cc/)
- [Видео уроки на Bilibili](https://www.bilibili.com/)

### Архитектура системы

Система состоит из двух ESP32 контроллеров:

1. **Главный контроллер** (`main_controller`)
   - Управление 4 DC моторами (по одному на каждое колесо)
   - Управление 8 сервоприводами (по 2 на каждую ногу)
   - Реализация алгоритмов движения и баланса
   - Прием команд управления через CAN шину
   - Отправка телеметрии через CAN шину

2. **Вспомогательный контроллер** (`aux_controller`)
   - Прием PPM сигнала от RC приемника
   - Декодирование PPM в отдельные каналы управления
   - Отправка команд управления главному контроллеру через CAN шину
   - Прием телеметрии от главного контроллера

### Связь между контроллерами

Контроллеры связаны через **CAN шину** со скоростью 500 кбит/с.

#### CAN сообщения:

- **ID 0x100**: Команды управления (от aux → main)
  - Байт 0: throttle (-100..100)
  - Байт 1: steering (-100..100)
  - Байт 2: mode (0..255)
  - Байт 3: speed (0..255)

- **ID 0x102**: Телеметрия (от main → aux)
  - Байт 0: статус системы
  - Байты 1-7: данные телеметрии

## Схема подключения

### Главный контроллер (ESP32 #1)

#### Моторы (PWM + Direction):
```
Передняя левая нога:
  - PWM: GPIO25
  - DIR1: GPIO26
  - DIR2: GPIO27

Передняя правая нога:
  - PWM: GPIO32
  - DIR1: GPIO33
  - DIR2: GPIO14

Задняя левая нога:
  - PWM: GPIO12
  - DIR1: GPIO13
  - DIR2: GPIO15

Задняя правая нога:
  - PWM: GPIO2
  - DIR1: GPIO4
  - DIR2: GPIO5
```

#### Сервоприводы:
```
Передняя левая нога:
  - Плечо: GPIO18
  - Бедро: GPIO19

Передняя правая нога:
  - Плечо: GPIO21
  - Бедро: GPIO22

Задняя левая нога:
  - Плечо: GPIO23
  - Бедро: GPIO16

Задняя правая нога:
  - Плечо: GPIO17
  - Бедро: GPIO35
```

#### CAN шина:
```
  - CAN_TX: GPIO5 → к CAN трансиверу (MCP2551/TJA1050)
  - CAN_RX: GPIO4 ← от CAN трансивера
```

### Вспомогательный контроллер (ESP32 #2)

#### PPM приемник:
```
  - PPM_IN: GPIO34 (вход от RC приемника)
```

#### CAN шина:
```
  - CAN_TX: GPIO5 → к CAN трансиверу
  - CAN_RX: GPIO4 ← от CAN трансивера
```

#### Индикация:
```
  - LED статус: GPIO2
  - LED сигнал: GPIO15
```

### CAN трансивер

Оба ESP32 подключаются к CAN шине через трансиверы (MCP2551 или TJA1050):

```
ESP32_1                 MCP2551                 CAN Bus
GPIO5 (TX) ──────────► TXD
GPIO4 (RX) ◄────────── RXD
                        CANH ─────────┬───────── CANH
                        CANL ─────────┴───────── CANL

ESP32_2                 MCP2551
GPIO5 (TX) ──────────► TXD
GPIO4 (RX) ◄────────── RXD
                        CANH ─────────┬
                        CANL ─────────┘
```

**Важно:** 
- Необходимы терминирующие резисторы 120 Ом на концах CAN шины
- Общий GND для всех устройств
- Питание 5V для CAN трансиверов

## Установка и сборка

### Требования

- [PlatformIO](https://platformio.org/) (рекомендуется использовать VSCode с расширением PlatformIO)
- USB кабель для прошивки ESP32
- CAN трансиверы (2 шт): MCP2551 или TJA1050

### Установка PlatformIO

1. Установите [Visual Studio Code](https://code.visualstudio.com/)
2. Установите расширение PlatformIO IDE из маркетплейса VSCode
3. Перезапустите VSCode

### Сборка прошивки

#### Для главного контроллера:

```bash
cd firmware/main_controller
pio run
```

#### Для вспомогательного контроллера:

```bash
cd firmware/aux_controller
pio run
```

## Прошивка ESP32

### Способ 1: Через PlatformIO (рекомендуется)

#### Прошивка главного контроллера:

1. Подключите ESP32 #1 к компьютеру через USB
2. Откройте папку `firmware/main_controller` в VSCode
3. В PlatformIO нажмите "Upload" или выполните:
   ```bash
   cd firmware/main_controller
   pio run --target upload
   ```
4. Для просмотра отладочных сообщений:
   ```bash
   pio device monitor
   ```

#### Прошивка вспомогательного контроллера:

1. Отключите ESP32 #1 и подключите ESP32 #2
2. Откройте папку `firmware/aux_controller` в VSCode
3. В PlatformIO нажмите "Upload" или выполните:
   ```bash
   cd firmware/aux_controller
   pio run --target upload
   ```
4. Для просмотра отладочных сообщений:
   ```bash
   pio device monitor
   ```

### Способ 2: Через esptool (альтернативный)

Если у вас уже собранная прошивка (.bin файл):

```bash
# Для главного контроллера
esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x10000 main_controller.bin

# Для вспомогательного контроллера
esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x10000 aux_controller.bin
```

**Примечание:** Замените `/dev/ttyUSB0` на актуальный COM-порт вашего ESP32.

### Определение COM-порта

#### Windows:
- Диспетчер устройств → Порты (COM и LPT)
- Обычно: COM3, COM4, и т.д.

#### Linux/macOS:
```bash
# Список портов
ls /dev/tty*

# Обычно: /dev/ttyUSB0 или /dev/ttyACM0 (Linux)
# Обычно: /dev/cu.usbserial-* (macOS)
```

## PPM каналы управления

По умолчанию используется следующий маппинг PPM каналов:

| Канал | Функция | Диапазон |
|-------|---------|----------|
| 0 | Газ (вперед/назад) | -100..100 |
| 1 | Рулевое управление | -100..100 |
| 2 | Режим работы (высота стойки) | 0..255 |
| 3 | Множитель скорости | 0..255 |
| 4 | Резерв (AUX1) | - |
| 5 | Резерв (AUX2) | - |

## Отладка

### Просмотр логов

#### Для главного контроллера:
```bash
cd firmware/main_controller
pio device monitor -b 115200
```

#### Для вспомогательного контроллера:
```bash
cd firmware/aux_controller
pio device monitor -b 115200
```

### Проверка CAN связи

1. Убедитесь, что оба ESP32 правильно подключены к CAN шине
2. Проверьте наличие терминирующих резисторов 120 Ом
3. Проверьте питание CAN трансиверов (5V)
4. В логах должны появиться сообщения о приеме/передаче CAN фреймов

### Типичные проблемы

**CAN связь не работает:**
- Проверьте подключение CANH и CANL
- Убедитесь в наличии терминирующих резисторов
- Проверьте общий GND
- Проверьте питание трансиверов

**PPM сигнал не принимается:**
- Проверьте подключение PPM выхода приемника к GPIO34
- Убедитесь, что приемник настроен на PPM режим
- Проверьте питание приемника

**Моторы не работают:**
- Проверьте питание драйверов моторов
- Проверьте подключение PWM и DIR пинов
- Убедитесь, что моторы подключены правильно

## Конфигурация

Основные параметры можно изменить в файлах:
- `firmware/main_controller/include/config.h` - для главного контроллера
- `firmware/aux_controller/include/config.h` - для вспомогательного контроллера

## Безопасность

⚠️ **ВАЖНО:**
- При потере PPM сигнала робот автоматически останавливается
- Всегда проверяйте подключение перед включением питания
- Начинайте с низких значений скорости
- Используйте аварийный выключатель питания

## Лицензия

Проект основан на открытых разработках StackForce и распространяется под лицензией Apache 2.0.

## Авторы и благодарности

- Основано на проектах: 
  - [StackForce Quadrupedal Wheeled Robot](https://gitee.com/StackForce/quadrupedal-wheeled-robot)
  - [StackForce Bipedal Wheeled Robot](https://gitee.com/StackForce/bipedal_wheeled_robot)
- Разработка прошивки: GOODWORKRINKZ

## Дополнительные ресурсы

- [Документация ESP32](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/)
- [PlatformIO документация](https://docs.platformio.org/)
- [Библиотека ESP32-Arduino-CAN](https://github.com/miwagner/ESP32-Arduino-CAN)
