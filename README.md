# Прошивка для четырехногого колесного робота StackForce

## Описание проекта

Этот проект содержит прошивку для четырехногого колесного робота с использованием двух ESP32 контроллеров, связанных через CAN шину.

### Архитектура системы

Система состоит из двух ESP32 контроллеров:

1. **Главный контроллер** (`main_controller`)
   - Управление 4 DC моторами (по одному на каждое колесо)
   - Управление 8 сервоприводами (по 2 на каждую ногу)
   - Реализация алгоритмов движения и баланса
   - Прием команд управления через CAN шину
   - Отправка телеметрии через CAN шину

2. **Вспомогательный контроллер** (`aux_controller`)
   - Прием PPM сигнала от RC приемника
   - Декодирование PPM в отдельные каналы управления
   - Отправка команд управления главному контроллеру через CAN шину
   - Прием телеметрии от главного контроллера

### Связь между контроллерами

Контроллеры связаны через **CAN шину** со скоростью 500 кбит/с.

#### CAN сообщения:

- **ID 0x100**: Команды управления (от aux → main)
  - Байт 0: throttle (-100..100)
  - Байт 1: steering (-100..100)
  - Байт 2: mode (0..255)
  - Байт 3: speed (0..255)

- **ID 0x102**: Телеметрия (от main → aux)
  - Байт 0: статус системы
  - Байты 1-7: данные телеметрии

## Схема подключения

### Главный контроллер (ESP32 #1)

#### Моторы (PWM + Direction):
```
Передняя левая нога:
  - PWM: GPIO25
  - DIR1: GPIO26
  - DIR2: GPIO27

Передняя правая нога:
  - PWM: GPIO32
  - DIR1: GPIO33
  - DIR2: GPIO14

Задняя левая нога:
  - PWM: GPIO12
  - DIR1: GPIO13
  - DIR2: GPIO15

Задняя правая нога:
  - PWM: GPIO2
  - DIR1: GPIO4
  - DIR2: GPIO5
```

#### Сервоприводы:
```
Передняя левая нога:
  - Плечо: GPIO18
  - Бедро: GPIO19

Передняя правая нога:
  - Плечо: GPIO21
  - Бедро: GPIO22

Задняя левая нога:
  - Плечо: GPIO23
  - Бедро: GPIO16

Задняя правая нога:
  - Плечо: GPIO17
  - Бедро: GPIO35
```

#### CAN шина:
```
  - CAN_TX: GPIO5 → к CAN трансиверу (MCP2551/TJA1050)
  - CAN_RX: GPIO4 ← от CAN трансивера
```

### Вспомогательный контроллер (ESP32 #2)

#### PPM приемник:
```
  - PPM_IN: GPIO34 (вход от RC приемника)
```

#### CAN шина:
```
  - CAN_TX: GPIO5 → к CAN трансиверу
  - CAN_RX: GPIO4 ← от CAN трансивера
```

#### Индикация:
```
  - LED статус: GPIO2
  - LED сигнал: GPIO15
```

### CAN трансивер

Оба ESP32 подключаются к CAN шине через трансиверы (MCP2551 или TJA1050):

```
ESP32_1                 MCP2551                 CAN Bus
GPIO5 (TX) ──────────► TXD
GPIO4 (RX) ◄────────── RXD
                        CANH ─────────┬───────── CANH
                        CANL ─────────┴───────── CANL

ESP32_2                 MCP2551
GPIO5 (TX) ──────────► TXD
GPIO4 (RX) ◄────────── RXD
                        CANH ─────────┬
                        CANL ─────────┘
```

**Важно:** 
- Необходимы терминирующие резисторы 120 Ом на концах CAN шины
- Общий GND для всех устройств
- Питание 5V для CAN трансиверов

## Установка и сборка

### Требования

- [PlatformIO](https://platformio.org/) (рекомендуется использовать VSCode с расширением PlatformIO)
- USB кабель для прошивки ESP32
- CAN трансиверы (2 шт): MCP2551 или TJA1050

### Установка PlatformIO

1. Установите [Visual Studio Code](https://code.visualstudio.com/)
2. Установите расширение PlatformIO IDE из маркетплейса VSCode
3. Перезапустите VSCode

### Сборка прошивки

#### Для главного контроллера:

```bash
cd firmware/main_controller
pio run
```

#### Для вспомогательного контроллера:

```bash
cd firmware/aux_controller
pio run
```

## Прошивка ESP32

### Способ 1: Через PlatformIO (рекомендуется)

#### Прошивка главного контроллера:

1. Подключите ESP32 #1 к компьютеру через USB
2. Откройте папку `firmware/main_controller` в VSCode
3. В PlatformIO нажмите "Upload" или выполните:
   ```bash
   cd firmware/main_controller
   pio run --target upload
   ```
4. Для просмотра отладочных сообщений:
   ```bash
   pio device monitor
   ```

#### Прошивка вспомогательного контроллера:

1. Отключите ESP32 #1 и подключите ESP32 #2
2. Откройте папку `firmware/aux_controller` в VSCode
3. В PlatformIO нажмите "Upload" или выполните:
   ```bash
   cd firmware/aux_controller
   pio run --target upload
   ```
4. Для просмотра отладочных сообщений:
   ```bash
   pio device monitor
   ```

### Способ 2: Через esptool (альтернативный)

Если у вас уже собранная прошивка (.bin файл):

```bash
# Для главного контроллера
esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x10000 main_controller.bin

# Для вспомогательного контроллера
esptool.py --chip esp32 --port /dev/ttyUSB0 write_flash 0x10000 aux_controller.bin
```

**Примечание:** Замените `/dev/ttyUSB0` на актуальный COM-порт вашего ESP32.

### Определение COM-порта

#### Windows:
- Диспетчер устройств → Порты (COM и LPT)
- Обычно: COM3, COM4, и т.д.

#### Linux/macOS:
```bash
# Список портов
ls /dev/tty*

# Обычно: /dev/ttyUSB0 или /dev/ttyACM0 (Linux)
# Обычно: /dev/cu.usbserial-* (macOS)
```

## PPM каналы управления

По умолчанию используется следующий маппинг PPM каналов:

| Канал | Функция | Диапазон |
|-------|---------|----------|
| 0 | Газ (вперед/назад) | -100..100 |
| 1 | Рулевое управление | -100..100 |
| 2 | Режим работы (высота стойки) | 0..255 |
| 3 | Множитель скорости | 0..255 |
| 4 | Резерв (AUX1) | - |
| 5 | Резерв (AUX2) | - |

## Отладка

### Просмотр логов

#### Для главного контроллера:
```bash
cd firmware/main_controller
pio device monitor -b 115200
```

#### Для вспомогательного контроллера:
```bash
cd firmware/aux_controller
pio device monitor -b 115200
```

### Проверка CAN связи

1. Убедитесь, что оба ESP32 правильно подключены к CAN шине
2. Проверьте наличие терминирующих резисторов 120 Ом
3. Проверьте питание CAN трансиверов (5V)
4. В логах должны появиться сообщения о приеме/передаче CAN фреймов

### Типичные проблемы

**CAN связь не работает:**
- Проверьте подключение CANH и CANL
- Убедитесь в наличии терминирующих резисторов
- Проверьте общий GND
- Проверьте питание трансиверов

**PPM сигнал не принимается:**
- Проверьте подключение PPM выхода приемника к GPIO34
- Убедитесь, что приемник настроен на PPM режим
- Проверьте питание приемника

**Моторы не работают:**
- Проверьте питание драйверов моторов
- Проверьте подключение PWM и DIR пинов
- Убедитесь, что моторы подключены правильно

## Конфигурация

Основные параметры можно изменить в файлах:
- `firmware/main_controller/include/config.h` - для главного контроллера
- `firmware/aux_controller/include/config.h` - для вспомогательного контроллера

## Безопасность

⚠️ **ВАЖНО:**
- При потере PPM сигнала робот автоматически останавливается
- Всегда проверяйте подключение перед включением питания
- Начинайте с низких значений скорости
- Используйте аварийный выключатель питания

## Лицензия

Проект основан на открытых разработках StackForce и распространяется под лицензией Apache 2.0.

## Авторы и благодарности

- Основано на проектах: 
  - [StackForce Quadrupedal Wheeled Robot](https://gitee.com/StackForce/quadrupedal-wheeled-robot)
  - [StackForce Bipedal Wheeled Robot](https://gitee.com/StackForce/bipedal_wheeled_robot)
- Разработка прошивки: GOODWORKRINKZ

## Дополнительные ресурсы

- [Документация ESP32](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/)
- [PlatformIO документация](https://docs.platformio.org/)
- [Библиотека ESP32-Arduino-CAN](https://github.com/miwagner/ESP32-Arduino-CAN)
