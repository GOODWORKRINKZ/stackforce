# Прошивка для калибровки офсетов сервоприводов

## Описание

Эта прошивка предназначена для определения офсетов сервоприводов четырехногого робота StackForce. Она позволяет:

1. **Читать текущие позиции** всех 8 сервоприводов (4 ноги × 2 серво)
2. **Выставить ноги робота** в нужное положение через Serial команды
3. **Получить офсеты** для корректировки в основной прошивке
4. **Непрерывный вывод** офсетов в консоль (каждые 100 мс)

## Аппаратные требования

- ESP32-S3 DevKit C-1
- PCA9685 (16-канальный PWM драйвер)
- 8 сервоприводов
- USB кабель для прошивки и Serial монитора

## Установка и прошивка

### 1. Прошивка ESP32

```bash
cd firmware/servo_calibration
pio run --target upload
```

### 2. Открытие Serial Monitor

```bash
pio device monitor -b 115200
```

Или используйте любой Serial терминал (Arduino IDE, PuTTY, и т.д.) с настройками:
- Baud rate: 115200
- Data bits: 8
- Parity: None
- Stop bits: 1

## Использование

### Шаг 1: Подключение и запуск

1. Подключите ESP32 к компьютеру через USB
2. Прошейте прошивку калибровки
3. Откройте Serial Monitor
4. Вы увидите приветственное сообщение и справку по командам

### Шаг 2: Установка сервоприводов в нужное положение

Используйте команды для установки углов сервоприводов:

```
s0 90        # Установить серво 0 (FL_SHOULDER) в 90°
s1 120       # Установить серво 1 (FL_HIP) в 120°
a 90         # Установить ВСЕ серво в 90°
n            # Установить все серво в нейтраль (90°)
```

### Шаг 3: Физическая настройка

1. Установите все серво в нейтральную позицию (90°) командой `n`
2. Физически выставьте ноги робота в желаемое положение
3. Вручную поворачивайте сервоприводы так, чтобы ноги были в правильном положении
4. **Или** используйте команды для регулировки углов, пока ноги не примут нужную позицию

### Шаг 4: Считывание офсетов

Прошивка автоматически выводит офсеты каждые 100 мс:

```
========================================
         КАЛИБРОВКА СЕРВОПРИВОДОВ       
========================================

Текущие углы и офсеты:
----------------------------------------
Серво          | Угол  | Офсет | Канал
----------------------------------------
FL_SHOULDER    |  90°  |   +0° | CH0
FL_HIP         | 120°  |  +30° | CH1
FR_SHOULDER    |  85°  |   -5° | CH2
FR_HIP         |  95°  |   +5° | CH3
BL_SHOULDER    |  90°  |   +0° | CH4
BL_HIP         |  90°  |   +0° | CH5
BR_SHOULDER    |  88°  |   -2° | CH6
BR_HIP         |  92°  |   +2° | CH7
----------------------------------------

Офсеты для config.h:
----------------------------------------
#define SERVO_FL_SHOULDER_OFFSET +0
#define SERVO_FL_HIP_OFFSET +30
#define SERVO_FR_SHOULDER_OFFSET -5
#define SERVO_FR_HIP_OFFSET +5
#define SERVO_BL_SHOULDER_OFFSET +0
#define SERVO_BL_HIP_OFFSET +0
#define SERVO_BR_SHOULDER_OFFSET -2
#define SERVO_BR_HIP_OFFSET +2
========================================
```

### Шаг 5: Применение офсетов

Скопируйте определения офсетов из вывода и добавьте их в файл `config.h` основной прошивки (`main_controller` или `aux_controller`).

Затем в коде используйте офсеты при установке углов:

```cpp
// Пример применения офсетов
servos.setAngle(SERVO_FL_SHOULDER, targetAngle + SERVO_FL_SHOULDER_OFFSET);
servos.setAngle(SERVO_FL_HIP, targetAngle + SERVO_FL_HIP_OFFSET);
```

## Команды Serial

| Команда | Описание | Пример |
|---------|----------|--------|
| `s<номер> <угол>` | Установить угол серво | `s0 90` |
| `a <угол>` | Установить все серво | `a 90` |
| `n` | Нейтральная позиция (90°) | `n` |
| `r` | Сбросить офсеты | `r` |
| `h` | Показать справку | `h` |

## Список сервоприводов

| Канал | Имя | Описание |
|-------|-----|----------|
| CH0 | FL_SHOULDER | Передняя левая нога - плечо |
| CH1 | FL_HIP | Передняя левая нога - бедро |
| CH2 | FR_SHOULDER | Передняя правая нога - плечо |
| CH3 | FR_HIP | Передняя правая нога - бедро |
| CH4 | BL_SHOULDER | Задняя левая нога - плечо |
| CH5 | BL_HIP | Задняя левая нога - бедро |
| CH6 | BR_SHOULDER | Задняя правая нога - плечо |
| CH7 | BR_HIP | Задняя правая нога - бедро |

## Конфигурация

Основные параметры можно изменить в файле `include/config.h`:

```cpp
// Диапазон импульсов серво (микросекунды)
#define SERVO_PULSE_MIN 150           // Минимальная ширина импульса
#define SERVO_PULSE_MAX 600           // Максимальная ширина импульса

// Интервал обновления вывода (мс)
#define UPDATE_INTERVAL 100           // Вывод каждые 100 мс

// Непрерывный вывод офсетов
#define CONTINUOUS_OUTPUT true        // true - постоянный вывод, false - по запросу
```

## Подключение

### I2C (PCA9685)

```
ESP32-S3         PCA9685
GPIO21 (SDA) ──► SDA
GPIO22 (SCL) ──► SCL
GND          ──► GND
3.3V         ──► VCC
```

### Питание сервоприводов

⚠️ **ВАЖНО:** Сервоприводы требуют отдельного питания!

```
PCA9685
V+  ──► Внешний источник питания 5-6V (3-5A)
GND ──► Общий GND с ESP32
```

### Светодиод статуса

```
ESP32-S3
GPIO2 ──► LED ──► 220Ω ──► GND
```

## Примеры использования

### Пример 1: Калибровка одной ноги

```
# Установить переднюю левую ногу в нейтраль
s0 90
s1 90

# Физически выставить ногу в правильное положение
# Затем скопировать офсеты из вывода
```

### Пример 2: Калибровка всех ног

```
# Установить все серво в нейтраль
n

# Физически выставить все ноги в правильное положение
# Затем скопировать все офсеты из вывода
```

### Пример 3: Тонкая настройка

```
# Установить конкретные углы для точной настройки
s0 85
s1 95
s2 90
s3 88
# ... и т.д.
```

## Принцип работы

1. **Инициализация**: PCA9685 инициализируется на частоте 50 Hz
2. **Нейтральная позиция**: Все серво устанавливаются в 90° при запуске
3. **Расчет офсетов**: Офсет = Текущий угол - 90°
4. **Вывод данных**: Каждые 100 мс выводятся текущие углы и офсеты
5. **Управление**: Serial команды позволяют менять углы в реальном времени

## Решение проблем

### Серво не двигаются

1. Проверьте питание сервоприводов (должно быть отдельное)
2. Проверьте подключение I2C (SDA, SCL)
3. Проверьте адрес PCA9685 (по умолчанию 0x40)

### Нет вывода в Serial Monitor

1. Проверьте скорость (115200 baud)
2. Проверьте USB подключение
3. Попробуйте нажать кнопку RESET на ESP32

### Серво дергаются

1. Проверьте питание (должно быть стабильное 5-6V)
2. Увеличьте емкость конденсатора на линии питания
3. Убедитесь, что источник питания выдает достаточный ток (3-5A)

## Дополнительные возможности

### Отключение непрерывного вывода

В файле `config.h` измените:

```cpp
#define CONTINUOUS_OUTPUT false
```

Тогда офсеты будут выводиться только при изменении углов.

### Изменение частоты вывода

В файле `config.h` измените:

```cpp
#define UPDATE_INTERVAL 500  // Вывод каждые 500 мс
```

## Лицензия

Apache 2.0 - часть проекта StackForce

## Авторы

- Разработка прошивки калибровки: GOODWORKRINKZ
- Основано на библиотеках проекта StackForce
