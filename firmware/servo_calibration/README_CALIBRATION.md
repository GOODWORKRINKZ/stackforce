# Калибровка сервоприводов StackForce

## Что это?

Система для калибровки офсетов 8 сервоприводов в **реальном времени** с визуальным контролем:
- **Прошивка** - принимает команды по Serial и применяет офсеты мгновенно
- **GUI приложение** - 8 слайдеров для настройки + сохранение в `.h` файл

## Быстрый старт

### 1. Прошить ESP32

```powershell
cd D:\PROGECTS\stackforce\firmware\servo_calibration
platformio run --target upload
platformio device monitor -b 115200
```

### 2. Запустить GUI

```powershell
cd D:\PROGECTS\stackforce
python calibration_gui.py
```

**Требования:**
```powershell
pip install pyserial
```

## Использование GUI

1. **Выбрать COM-порт** → Нажать "Подключить"
2. **Двигать слайдеры** или вводить значения → Серво движутся мгновенно
3. Когда все ноги выровнены → **"Сохранить в quadrupedal_data.h"**
4. Скопировать офсеты в `firmware/main_controller/include/quadrupedal_data.h`

## Команды Serial (ручной режим)

Можно калибровать через Serial Monitor:

- `o<канал> <офсет>` - Установить офсет (например: `o0 -15`)
- `a 90` - Все серво на 90°
- `p` - Вывести текущие офсеты
- `r` - Сбросить все в 0
- `h` - Помощь

**Пример:**
```
o0 -15      # FR_FRONT офсет -15°
o1 20       # FR_REAR офсет +20°
p           # Показать все офсеты
```

## Маппинг каналов

| Индекс | Канал PCA9685 | Название    |
|--------|---------------|-------------|
| 0      | 11            | FL_FRONT    |
| 1      | 10            | FL_REAR     |
| 2      | 0             | FR_FRONT    |
| 3      | 1             | FR_REAR     |
| 4      | 4             | BL_FRONT    |
| 5      | 5             | BL_REAR     |
| 6      | 6             | BR_FRONT    |
| 7      | 7             | BR_REAR     |

## Файлы проекта

```
firmware/servo_calibration/
├── src/
│   ├── main.cpp                    # ← Новая калибровка (реал-тайм)
│   ├── main_old_backup.cpp         # Старая версия (бэкап)
│   └── calibration_realtime.cpp    # Исходник (дубликат)
├── lib/
│   └── SF_Servo/                   # Библиотека PCA9685
└── platformio.ini

calibration_gui.py                   # Python GUI
```

## Что делает прошивка?

1. Инициализирует PCA9685
2. Устанавливает **все серво на 90°**
3. Ждёт команды по Serial
4. При получении `o<канал> <офсет>`:
   - Сохраняет офсет
   - Применяет: `servos.setAngle(канал, 90 + офсет)`
   - Серво едет **мгновенно**

## Процесс калибровки

1. **Прошить** → Все серво встают на 90°
2. **Прикрутить ноги** чтобы были вертикально
3. **Запустить GUI** и подключиться
4. **Для каждой ноги:**
   - Двигать слайдер пока нога не станет вертикально
   - Записать значение
5. **Сохранить** в `.h` файл
6. **Скопировать** офсеты в `main_controller`

## Troubleshooting

**GUI не видит порт:**
- Закрыть Serial Monitor перед подключением
- Проверить драйвер CH340/CP2102

**Серво не двигаются:**
- Проверить питание PCA9685 (5V)
- Проверить I2C (SDA=GPIO1, SCL=GPIO2)
- Открыть Serial Monitor → команда `p`

**Слайдер не работает:**
- Проверить что COM-порт подключен (зелёная надпись)
- Посмотреть лог внизу GUI

## Следующий шаг

После калибровки:
1. Офсеты скопировать в `firmware/main_controller/include/quadrupedal_data.h`
2. Прошить `main_controller`
3. Робот будет стартовать с правильной позицией!
