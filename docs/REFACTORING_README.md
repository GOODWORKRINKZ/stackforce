# Новая архитектура робота - Классы Leg и Robot

## Описание

Рефакторинг кода для улучшения структуры и управляемости. Логика разделена на два основных класса:

### Класс `Leg` (Нога)
Инкапсулирует всю логику управления одной ногой робота:
- **Метод `moveTo(x, y)`** - перемещает ногу в указанную позицию
- Автоматический расчет обратной кинематики
- Управление сервоприводами
- Хранение текущих координат
- Применение калибровочных смещений

**Файлы:**
- `include/Leg.h`
- `lib/Leg/Leg.cpp`

### Класс `Robot` (Робот)
Управляет всем роботом и его компонентами:
- Управление 4 ногами (через объекты класса `Leg`)
- Управление моторами (BLDC)
- Чтение датчиков (IMU, RC)
- PID стабилизация
- CAN коммуникация
- Конфигурация и настройки

**Файлы:**
- `include/Robot.h`
- `lib/Robot/Robot.cpp`

## Структура файлов

```
main_controller/
├── include/
│   ├── Leg.h              # Объявление класса Leg
│   ├── Robot.h            # Объявление класса Robot
│   ├── quadrupedal_data.h # Структуры данных (старая версия)
│   ├── kinematics.h       # Кинематика (старая версия)
│   └── config.h           # Конфигурация
├── lib/
│   ├── Leg/
│   │   └── Leg.cpp        # Реализация класса Leg
│   └── Robot/
│       └── Robot.cpp      # Реализация класса Robot
└── src/
    ├── main.cpp           # СТАРЫЙ main (текущая версия)
    └── main.cpp       # НОВЫЙ main (упрощенный)
```

## Использование

### Переход на новую архитектуру

1. **Сохраните старый код:**
   ```bash
   # Переименуйте текущий main.cpp
   mv src/main.cpp src/main_old.cpp
   ```

2. **Активируйте новую версию:**
   ```bash
   # Переименуйте новый main
   mv src/main.cpp src/main.cpp
   ```

3. **Скомпилируйте проект:**
   ```bash
   pio run
   ```

### Пример использования классов

```cpp
#include "Robot.h"

Robot robot;

void setup() {
    // Инициализация робота
    robot.init();
}

void loop() {
    // Обновление состояния робота
    robot.update();
    
    // Управление отдельными ногами
    robot.moveLegFL(0, 100);    // Передняя левая нога
    robot.moveLegFR(0, 100);    // Передняя правая нога
    robot.moveLegBL(0, 100);    // Задняя левая нога
    robot.moveLegBR(0, 100);    // Задняя правая нога
    
    // Управление всеми ногами сразу
    robot.moveAllLegsTo(0, 100);
    
    // Установка высоты
    robot.setHeight(100);
    
    // Управление режимами
    robot.setMotors(true);          // Включить моторы
    robot.setStabilization(true);   // Включить стабилизацию
    robot.setIK(true);              // Включить обратную кинематику
}
```

### Serial команды

После загрузки новой версии доступны следующие команды через Serial Monitor:

- `motors on` / `motors off` - включить/выключить моторы
- `stab on` / `stab off` - включить/выключить стабилизацию
- `ik on` / `ik off` - включить/выключить обратную кинематику
- `h <высота>` - установить высоту всех ног (70-130 мм)
  - Пример: `h 100`
- `move <нога> <x> <y>` - переместить ногу
  - Ноги: `fl` (передняя левая), `fr` (передняя правая), `bl` (задняя левая), `br` (задняя правая), `all` (все)
  - Пример: `move fl 0 100` - передняя левая нога в позицию X=0, Y=100
  - Пример: `move all 0 115` - все ноги в позицию X=0, Y=115

## Преимущества новой архитектуры

### 1. **Модульность**
- Логика ноги отделена от логики робота
- Легко добавить новые функции к ноге без изменения основного кода
- Каждая нога - независимый объект

### 2. **Упрощение кода**
- `main.cpp` стал намного короче и понятнее
- Вся сложная логика скрыта внутри классов
- Легче читать и поддерживать

### 3. **Переиспользование**
- Класс `Leg` можно использовать для разных типов роботов
- Класс `Robot` содержит всю специфику текущего робота
- Легко масштабировать на больше/меньше ног

### 4. **Тестирование**
- Можно тестировать каждую ногу отдельно
- Можно тестировать робот без реальных ног (mock объекты)
- Проще находить и исправлять ошибки

### 5. **Управление конфигурацией**
- Все настройки робота в одном месте (`Robot` класс)
- Легко переключаться между режимами
- Централизованное управление всеми устройствами

## Миграция старого кода

Если у вас есть специфический код из старого `main.cpp`, его легко перенести:

### Пример: Добавление новой функции в `Robot`

1. Объявите метод в `Robot.h`:
```cpp
class Robot {
public:
    void customBehavior();
};
```

2. Реализуйте в `Robot.cpp`:
```cpp
void Robot::customBehavior() {
    // Ваш код здесь
}
```

3. Вызовите в `main.cpp`:
```cpp
void loop() {
    robot.customBehavior();
    robot.update();
}
```

## Возврат к старой версии

Если что-то пошло не так:

```bash
# Верните старый main.cpp
mv src/main.cpp src/main.cpp
mv src/main_old.cpp src/main.cpp

# Скомпилируйте
pio run
```

## Дальнейшее развитие

Возможные улучшения:

1. **Класс `Gait`** - для управления походками (trot, walk, etc.)
2. **Класс `MotionController`** - для сложных движений
3. **Класс `Sensor`** - абстракция для всех датчиков
4. **Класс `Communication`** - для CAN/Serial коммуникации
5. **Система состояний** - State Machine для управления режимами

## Примечания

- Старая версия `main.cpp` полностью функциональна и работает
- Новая версия - рефакторинг для улучшения архитектуры
- Функционал обеих версий идентичен
- Калибровочные смещения сохранены из оригинальной версии
- Все параметры из `quadrupedal_data.h` используются
