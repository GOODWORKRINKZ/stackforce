# Подключение железа - StackForce Quadrupedal Robot

## Main Controller (ESP32-S3)

### CAN/RS485 модуль StackForce
```
CANTX -> GPIO35
CANRX -> GPIO41
GND   -> GND
5V    -> 5V
```

### PCA9685 (сервоприводы)
```
SDA -> GPIO1
SCL -> GPIO2
VCC -> 5V
GND -> GND
V+  -> 6V (питание серво, отдельное!)
```

**Подключение 8 сервоприводов:**
```
Канал 1 -> Front Right Rear
Канал 2 -> Front Right Front
Канал 3 -> Front Left Front
Канал 4 -> Front Left Rear
Канал 5 -> Back Right Rear
Канал 6 -> Back Right Front
Канал 7 -> Back Left Front
Канал 8 -> Back Left Rear
```

### MPU6050 (IMU)
```
SDA -> GPIO1 (общий I2C с PCA9685)
SCL -> GPIO2
VCC -> 3.3V
GND -> GND
```

### SBUS приемник (FrSky)
```
Signal -> GPIO16 (Serial1 RX)
VCC    -> 5V
GND    -> GND
```

### BLDC моторы M0, M1 (передние)
```
Serial2 TX -> GPIO18
Serial2 RX -> GPIO17
```

**Подключение моторов:**
- M0 = передний левый
- M1 = передний правый

---

## Aux Controller (ESP32-S3)

### CAN/RS485 модуль StackForce
```
CANTX -> GPIO35
CANRX -> GPIO41
GND   -> GND
5V    -> 5V
```

⚠️ **Важно:** Включить терминальные резисторы 120Ω на обоих концах CAN шины!

### BLDC моторы M2, M3 (задние)
```
Serial2 TX -> GPIO18
Serial2 RX -> GPIO17
```

**Подключение моторов:**
- M2 = задний левый
- M3 = задний правый

---

## Схема CAN шины

```
Main Controller          CAN/RS485 Module 1
  GPIO35 (TX) ──────────── CANTX
  GPIO41 (RX) ──────────── CANRX
                           CANH ────┐
                           CANL ────┤
                                    │
                            120Ω ───┤  (терминальный резистор)
                                    │
                                    │ Twisted Pair Cable
                                    │ (витая пара, макс 40м @ 1Mbps)
                                    │
                            120Ω ───┤  (терминальный резистор)
                                    │
                           CANH ────┤
                           CANL ────┘
  GPIO35 (TX) ──────────── CANTX
  GPIO41 (RX) ──────────── CANRX
Aux Controller          CAN/RS485 Module 2
```

---

## Питание

### Main Controller
- ESP32: USB (5V) или внешний 5V
- Серво (8 шт): 6V 5A+ (отдельный BEC!)
- BLDC M0,M1: LiPo 3S (11.1V)

### Aux Controller
- ESP32: USB (5V) или внешний 5V
- BLDC M2,M3: LiPo 3S (11.1V)

⚠️ **Критично:** Общая земля (GND) между всеми компонентами!

---

## Настройка CAN модулей

На каждом CAN/RS485 модуле:

1. **Terminal resistor switch** - включить на ОБОИХ модулях (NCR 120R)
2. **Проверить:** переключатели в положении CAN (не RS485)
3. **Питание:** 5V от ESP32

---

## Проверка подключения

### 1. I2C устройства (Main)
```cpp
// В Serial Monitor должно появиться:
// PCA9685 found at 0x40
// MPU6050 found at 0x68
```

### 2. CAN шина
```cpp
// Main отправляет пакеты -> LED мигает на CAN модуле
// Aux принимает пакеты -> LED мигает на CAN модуле
```

### 3. SBUS приемник
```cpp
// Включить пульт -> Serial показывает значения каналов
// CH1-CH16: 172...1811
```

### 4. BLDC моторы
```cpp
// При инициализации моторы должны "пикнуть"
// Serial2 должен показывать телеметрию от моторов
```

---

## Troubleshooting

### CAN не работает
- ✅ Проверить терминальные резисторы (оба включены?)
- ✅ Проверить витую пару (CANH-CANL не перепутаны?)
- ✅ Проверить GPIO35/41 (правильно подключены TX/RX?)
- ✅ Общая земля между контроллерами

### Сервоприводы дергаются
- ✅ Отдельное питание 6V для серво (не от ESP32!)
- ✅ Общая земля между BEC и ESP32
- ✅ Проверить I2C подтяжки (4.7kΩ на SDA/SCL)

### IMU не инициализируется
- ✅ Проверить I2C адрес (должен быть 0x68)
- ✅ Подтяжки 4.7kΩ на SDA/SCL
- ✅ Питание 3.3V (НЕ 5V!)

### SBUS нет сигнала
- ✅ Приемник запитан 5V
- ✅ Пульт включен и привязан к приемнику
- ✅ GPIO16 подключен к сигнальному пину SBUS
- ✅ Инверсия сигнала (SBUS инвертирован, но библиотека это учитывает)

### BLDC не отвечают
- ✅ Serial2 правильно подключен (TX-RX перекрестно!)
- ✅ Моторы запитаны от LiPo
- ✅ Скорость 115200 baud
- ✅ Моторы откалиброваны
