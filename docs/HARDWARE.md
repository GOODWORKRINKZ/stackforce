# Схема подключения аппаратуры StackForce

## Обзор системы

Система состоит из двух ESP32 контроллеров, соединенных через CAN шину.

```
┌─────────────────────────────────────────────────────────────────────┐
│                    СИСТЕМА УПРАВЛЕНИЯ РОБОТА                         │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────────────┐         CAN BUS          ┌──────────────────────┐
│  ESP32 #2 (PPM+IMU) │◄──────────────────────────►│  ESP32 #1 (MAIN)    │
│  Вспомогательный    │   CANH + CANL + GND      │  Главный контроллер │
└──────────────────────┘   (1 Mbps)               └──────────────────────┘
         │                                                    │
         │                                                    │
    ┌────▼────┐                                          ┌────▼────┐
    │ PPM RX  │                                          │ PCA9685 │
    │ MPU6050 │                                          │ Servo   │
    └─────────┘                                          │ Driver  │
                                                         └────┬────┘
                                                              │
                                                    ┌─────────┴─────────┐
                                                    │                   │
                                              ┌─────▼─────┐      ┌─────▼─────┐
                                              │ 8 Servos  │      │ 4 BLDC    │
                                              │ (Legs)    │      │ Motors    │
                                              └───────────┘      └───────────┘
```

## ESP32 #1 - Главный контроллер

### Назначение
- Управление 4 BLDC моторами через CAN шину
- Управление 8 сервоприводами через PCA9685 (I2C)
- Прием команд от ESP32 #2
- Реализация алгоритмов движения

### Схема подключения

```
                    ┌────────────────────┐
                    │     ESP32 #1       │
                    │  (Главный)         │
                    └────────────────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
    ┌────▼────┐         ┌────▼────┐         ┌────▼────┐
    │ CAN BUS │         │ I2C Bus │         │  LEDs   │
    └─────────┘         └─────────┘         └─────────┘
         │                   │                   │
    GPIO 4,5            GPIO 21,22           GPIO 2,15
         │                   │
         ▼                   ▼
    MCP2551              PCA9685
         │                   │
         │                   ├──► 8 Servos
         │                   
         ├──► BLDC Motor FL (0x141)
         ├──► BLDC Motor FR (0x142)
         ├──► BLDC Motor BL (0x143)
         └──► BLDC Motor BR (0x144)
```

### Распиновка

| Функция | GPIO | Подключение |
|---------|------|-------------|
| CAN RX | 4 | MCP2551 RXD |
| CAN TX | 5 | MCP2551 TXD |
| I2C SDA | 21 | PCA9685 SDA |
| I2C SCL | 22 | PCA9685 SCL |
| LED Status | 2 | LED + резистор 220Ω |
| LED CAN | 15 | LED + резистор 220Ω |
| GND | GND | Общий GND |
| 3.3V | 3.3V | Питание логики |

### Подключение PCA9685

```
ESP32 #1          PCA9685
GPIO21 (SDA) ──── SDA
GPIO22 (SCL) ──── SCL
GND ───────────── GND
3.3V ──────────── VCC (логика)
                  V+ ──── 5-6V (питание серво)
```

#### Каналы PCA9685 для сервоприводов:

| Канал | Нога | Сустав | Описание |
|-------|------|--------|----------|
| 0 | FL | Плечо | Передняя левая |
| 1 | FL | Бедро | Передняя левая |
| 2 | FR | Плечо | Передняя правая |
| 3 | FR | Бедро | Передняя правая |
| 4 | BL | Плечо | Задняя левая |
| 5 | BL | Бедро | Задняя левая |
| 6 | BR | Плечо | Задняя правая |
| 7 | BR | Бедро | Задняя правая |

### Подключение BLDC моторов

BLDC моторы подключаются к CAN шине со следующими ID:

| Мотор | CAN ID | Позиция |
|-------|--------|---------|
| FL | 0x141 | Передний левый |
| FR | 0x142 | Передний правый |
| BL | 0x143 | Задний левый |
| BR | 0x144 | Задний правый |

## ESP32 #2 - PPM контроллер с IMU

### Назначение
- Прием PPM сигнала от RC приемника
- Чтение данных IMU (MPU6050)
- Фильтрация IMU (комплементарный фильтр)
- Отправка команд по CAN шине

### Схема подключения

```
                    ┌────────────────────┐
                    │     ESP32 #2       │
                    │   (PPM + IMU)      │
                    └────────────────────┘
                             │
         ┌───────────────────┼───────────────────┬───────────┐
         │                   │                   │           │
    ┌────▼────┐         ┌────▼────┐         ┌────▼────┐ ┌────▼────┐
    │ CAN BUS │         │ I2C Bus │         │  PPM    │ │  LEDs   │
    └─────────┘         └─────────┘         └─────────┘ └─────────┘
         │                   │                   │           │
    GPIO 4,5            GPIO 21,22           GPIO 34    GPIO 2,15,16,17
         │                   │                   │
         ▼                   ▼                   ▼
    MCP2551              MPU6050           RC Receiver
```

### Распиновка

| Функция | GPIO | Подключение |
|---------|------|-------------|
| CAN RX | 4 | MCP2551 RXD |
| CAN TX | 5 | MCP2551 TXD |
| I2C SDA | 21 | MPU6050 SDA |
| I2C SCL | 22 | MPU6050 SCL |
| PPM Input | 34 | RC Receiver PPM Out |
| LED Status | 2 | LED + резистор 220Ω |
| LED CAN | 15 | LED + резистор 220Ω |
| LED PPM | 16 | LED + резистор 220Ω |
| LED IMU | 17 | LED + резистор 220Ω |

### Подключение MPU6050

```
ESP32 #2          MPU6050
GPIO21 (SDA) ──── SDA
GPIO22 (SCL) ──── SCL
GND ───────────── GND
3.3V ──────────── VCC
```

### Подключение PPM приемника

```
RC Receiver       ESP32 #2
PPM Out ───────── GPIO 34
GND ───────────── GND
VCC (5V) ──────── 5V (через стабилизатор)
```

## CAN шина

### Физическая топология

```
┌────────────┐         ┌──────────────┐         ┌────────────┐
│  ESP32 #2  │         │              │         │  ESP32 #1  │
│            │         │   CAN BUS    │         │            │
│  MCP2551   │         │              │         │  MCP2551   │
│  CANH ─────┼─────────┤ CANH ────────┼─────────┤──── CANH  │
│  CANL ─────┼─────────┤ CANL ────────┼─────────┤──── CANL  │
│  GND ──────┼─────────┤ GND ─────────┼─────────┤──── GND   │
└────────────┘         └──────────────┘         └────────────┘
      │                                                  │
     120Ω                                              120Ω
  (терминатор)                                    (терминатор)
                              │
                         ┌────┴────┐
                         │ BLDC    │
                         │ Motors  │
                         │ x4      │
                         └─────────┘
```

### Подключение CAN трансивера (MCP2551)

```
ESP32             MCP2551            CAN Bus
GPIO5 (TX) ────► TXD
GPIO4 (RX) ◄──── RXD
GND ──────────── GND ───────────────┐
5V ───────────── VCC                │
                 CANH ──────────────┤
                 CANL ──────────────┤
                                    │
                          [120Ω терминатор]
```

### Терминаторы CAN шины

На каждом конце CAN шины установите резистор 120Ом:

```
CANH ──┬──[120Ω]──┬── CANL
```

**Важно:**
- Только на концах шины!
- Если на плате уже есть терминатор - проверьте перемычкой
- Общее сопротивление между CANH и CANL должно быть ~60Ом (два параллельных 120Ω)

## Питание системы

### Рекомендуемая схема питания

```
                    ┌──────────────┐
                    │   Li-Po 3S   │
                    │  11.1V (9-12.6V)│
                    └───────┬──────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
       ┌────▼────┐    ┌─────▼────┐    ┌────▼────┐
       │ DC-DC   │    │ DC-DC    │    │ BLDC    │
       │ 5V/3A   │    │ 6V/3A    │    │ Motors  │
       └────┬────┘    └────┬─────┘    └─────────┘
            │              │               │
    ┌───────┼───────┐      │               └─► 4x BLDC (11.1V)
    │       │       │      │
┌───▼──┐ ┌──▼───┐ ┌▼──────▼─┐
│ESP32 │ │ESP32 │ │Servos   │
│  #1  │ │  #2  │ │8x MG996R│
└──────┘ └──────┘ └─────────┘
```

### Спецификация питания

| Компонент | Напряжение | Ток | Примечание |
|-----------|------------|-----|------------|
| ESP32 #1 | 5V → 3.3V | 500mA | Встроенный стабилизатор |
| ESP32 #2 | 5V → 3.3V | 500mA | Встроенный стабилизатор |
| MPU6050 | 3.3V | 3.5mA | От ESP32 |
| PCA9685 | 3.3V (логика) | 10mA | От ESP32 |
| Сервоприводы | 5-6V | 2-3A | Отдельный стабилизатор! |
| BLDC моторы | 11.1V | До 20A | Прямо от батареи |
| CAN трансиверы | 5V | 10mA | От стабилизатора 5V |

### Важные замечания по питанию:

1. **ESP32**: Питается от 5V через встроенный стабилизатор
2. **Сервоприводы**: Обязательно отдельное питание 5-6V/3A
3. **Логика и силовая часть**: Разделить!
4. **Общий GND**: Обязателен для всех компонентов
5. **Конденсаторы**: 100µF + 0.1µF на каждом потребителе
6. **Предохранители**: На всех силовых линиях

## Спецификация компонентов (BOM)

| Компонент | Модель/Тип | Кол-во | Описание |
|-----------|------------|--------|----------|
| Микроконтроллер | ESP32 DevKit V1 | 2 | 30 pin |
| CAN трансивер | MCP2551 | 2 | С модулем |
| Servo драйвер | PCA9685 | 1 | 16-канальный PWM |
| IMU | MPU6050 | 1 | 6DOF гироскоп+акселерометр |
| BLDC мотор | С CAN интерфейсом | 4 | Например, StackForce |
| Сервопривод | MG996R | 8 | 10+ кг·см |
| RC приемник | FlySky FS-iA6B | 1 | PPM выход |
| DC-DC 5V | LM2596 или аналог | 1 | 3A |
| DC-DC 6V | LM2596 или аналог | 1 | 3A для серво |
| Батарея | Li-Po 3S 2200mAh | 1 | 30C |
| Резистор 120Ω | 1/4W | 2 | CAN терминаторы |
| Резистор 220Ω | 1/4W | 8 | Для LED |
| LED | 5мм | 8 | Индикация |
| Конденсатор | 100µF 16V | 10 | Развязка питания |
| Конденсатор | 0.1µF 50V | 10 | Развязка питания |
| Провода | AWG22-24 | - | Витая пара для CAN |

## Проверка подключения

### Мультиметр - базовая проверка

1. **Сопротивление CAN**: между CANH и CANL = ~60Ω
2. **Питание ESP32**: между 5V и GND = 5V ±0.2V
3. **Питание серво**: между V+ и GND = 5-6V
4. **Общий GND**: проверьте непрерывность между всеми GND

### Логический анализатор / Осциллограф

1. **CAN сигналы**: дифференциальные импульсы 2-3V
2. **I2C**: частота 100-400kHz
3. **PPM**: импульсы 1000-2000µs, период 20ms
4. **PWM серво**: импульсы 1-2ms, частота 50Hz

## Отладка

### LED индикация

#### ESP32 #1 (Главный):
- **GPIO 2 (Status)**: Мигает 1 раз в секунду = работает
- **GPIO 15 (CAN)**: Мигает при приеме CAN = связь OK

#### ESP32 #2 (PPM):
- **GPIO 2 (Status)**: Мигает 2 раза в секунду = работает
- **GPIO 15 (CAN)**: Мигает при отправке CAN
- **GPIO 16 (PPM)**: Горит при приеме PPM
- **GPIO 17 (IMU)**: Горит постоянно = IMU OK

### Типичные проблемы

**CAN не работает:**
- Проверьте терминаторы
- Проверьте CANH/CANL (не перепутаны ли?)
- Проверьте общий GND
- Питание трансиверов 5V

**I2C не работает:**
- Проверьте подтягивающие резисторы (обычно встроены в модули)
- Сканируйте адреса: `Wire.begin(); Wire.scan();`
- MPU6050 = 0x68, PCA9685 = 0x40

**PPM не принимается:**
- Проверьте режим приемника (PPM, не PWM!)
- GPIO34 - только вход
- Проверьте триггер прерывания (RISING)

## Безопасность

⚠️ **КРИТИЧЕСКИ ВАЖНО:**

1. **Аварийный выключатель**: Обязателен!
2. **Предохранители**: На всех силовых линиях
3. **Изоляция**: Силовые и сигнальные линии раздельно
4. **Первый запуск**: Робот на подставке!
5. **Защита**: Не прикасайтесь к вращающимся частям

## Дополнительные ресурсы

- [Руководство по быстрому старту](QUICKSTART.md)
- [README проекта](../README.md)
- [Документация ESP32](https://docs.espressif.com/)
- [Документация PCA9685](https://www.nxp.com/docs/en/data-sheet/PCA9685.pdf)
- [CAN Bus Theory](https://www.ti.com/lit/an/sloa101b/sloa101b.pdf)
